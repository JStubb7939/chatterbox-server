'use strict';

var handler = require('../request-handler');
var expect = require('chai').expect;
var stubs = require('./Stubs');

// Conditional async testing, akin to Jasmine's waitsFor()
// Will wait for test to be truthy before executing callback
var waitForThen = function waitForThen(test, cb) {
  setTimeout(function () {
    test() ? cb.apply(this) : waitForThen(test, cb);
  }, 5);
};

describe('Node Server Request Listener Function', function () {
  it('Should answer GET requests for /classes/messages with a 200 status code', function () {
    // This is a fake server request. Normally, the server would provide this,
    // but we want to test our function's behavior totally independent of the server code
    var req = new stubs.request('/classes/messages', 'GET');
    var res = new stubs.response();

    handler(req, res);

    expect(res._responseCode).to.equal(200);
    expect(res._ended).to.equal(true);
  });

  it('Should send back parsable stringified JSON', function () {
    var req = new stubs.request('/classes/messages', 'GET');
    var res = new stubs.response();

    handler(req, res);

    expect(JSON.parse.bind(this, res._data)).to.not.throw();
    expect(res._ended).to.equal(true);
  });

  it('Should send back an object', function () {
    var req = new stubs.request('/classes/messages', 'GET');
    var res = new stubs.response();

    handler(req, res);

    var parsedBody = JSON.parse(res._data);
    expect(parsedBody).to.be.an('object');
    expect(res._ended).to.equal(true);
  });

  it('Should send an object containing a `results` array', function () {
    var req = new stubs.request('/classes/messages', 'GET');
    var res = new stubs.response();

    handler(req, res);

    var parsedBody = JSON.parse(res._data);
    expect(parsedBody).to.have.property('results');
    expect(parsedBody.results).to.be.an('array');
    expect(res._ended).to.equal(true);
  });

  it('Should accept posts to /classes/room', function () {
    var stubMsg = {
      username: 'Jono',
      message: 'Do my bidding!'
    };
    var req = new stubs.request('/classes/messages', 'POST', stubMsg);
    var res = new stubs.response();

    handler(req, res);

    // Expect 201 Created response status
    expect(res._responseCode).to.equal(201);

    // Testing for a newline isn't a valid test
    // TODO: Replace with with a valid test
    // expect(res._data).to.equal(JSON.stringify('\n'));
    expect(res._ended).to.equal(true);
  });

  it('Should respond with messages that were previously posted', function () {
    var stubMsg = {
      username: 'Jono',
      message: 'Do my bidding!'
    };
    var req = new stubs.request('/classes/messages', 'POST', stubMsg);
    var res = new stubs.response();

    handler(req, res);

    expect(res._responseCode).to.equal(201);

    // Now if we request the log for that room the message we posted should be there:
    req = new stubs.request('/classes/messages', 'GET');
    res = new stubs.response();

    handler(req, res);

    expect(res._responseCode).to.equal(200);
    var messages = JSON.parse(res._data).results;
    expect(messages.length).to.be.above(0);
    expect(messages[0].username).to.equal('Jono');
    expect(messages[0].message).to.equal('Do my bidding!');
    expect(res._ended).to.equal(true);
  });

  it('Should 404 when asked for a nonexistent file', function () {
    var req = new stubs.request('/arglebargle', 'GET');
    var res = new stubs.response();

    handler(req, res);

    // Wait for response to return and then check status code
    waitForThen(function () {
      return res._ended;
    }, function () {
      expect(res._responseCode).to.equal(404);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zcGVjL1NlcnZlclNwZWMuanMiXSwibmFtZXMiOlsiaGFuZGxlciIsInJlcXVpcmUiLCJleHBlY3QiLCJzdHVicyIsIndhaXRGb3JUaGVuIiwidGVzdCIsImNiIiwic2V0VGltZW91dCIsImFwcGx5IiwiZGVzY3JpYmUiLCJpdCIsInJlcSIsInJlcXVlc3QiLCJyZXMiLCJyZXNwb25zZSIsIl9yZXNwb25zZUNvZGUiLCJ0byIsImVxdWFsIiwiX2VuZGVkIiwiSlNPTiIsInBhcnNlIiwiYmluZCIsIl9kYXRhIiwibm90IiwidGhyb3ciLCJwYXJzZWRCb2R5IiwiYmUiLCJhbiIsImhhdmUiLCJwcm9wZXJ0eSIsInJlc3VsdHMiLCJzdHViTXNnIiwidXNlcm5hbWUiLCJtZXNzYWdlIiwibWVzc2FnZXMiLCJsZW5ndGgiLCJhYm92ZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxVQUFVQyxRQUFRLG9CQUFSLENBQWQ7QUFDQSxJQUFJQyxTQUFTRCxRQUFRLE1BQVIsRUFBZ0JDLE1BQTdCO0FBQ0EsSUFBSUMsUUFBUUYsUUFBUSxTQUFSLENBQVo7O0FBRUE7QUFDQTtBQUNBLElBQUlHLGNBQWMsU0FBZEEsV0FBYyxDQUFVQyxJQUFWLEVBQWdCQyxFQUFoQixFQUFvQjtBQUNwQ0MsYUFBVyxZQUFXO0FBQ3BCRixhQUFTQyxHQUFHRSxLQUFILENBQVMsSUFBVCxDQUFULEdBQTBCSixZQUFZQyxJQUFaLEVBQWtCQyxFQUFsQixDQUExQjtBQUNELEdBRkQsRUFFRyxDQUZIO0FBR0QsQ0FKRDs7QUFNQUcsU0FBUyx1Q0FBVCxFQUFrRCxZQUFXO0FBQzNEQyxLQUFHLHlFQUFILEVBQThFLFlBQVc7QUFDdkY7QUFDQTtBQUNBLFFBQUlDLE1BQU0sSUFBSVIsTUFBTVMsT0FBVixDQUFrQixtQkFBbEIsRUFBdUMsS0FBdkMsQ0FBVjtBQUNBLFFBQUlDLE1BQU0sSUFBSVYsTUFBTVcsUUFBVixFQUFWOztBQUVBZCxZQUFRVyxHQUFSLEVBQWFF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QUFvQixLQURuQyxFQUVFLFlBQVc7QUFDVGhCLGFBQU9XLElBQUlFLGFBQVgsRUFBMEJDLEVBQTFCLENBQTZCQyxLQUE3QixDQUFtQyxHQUFuQztBQUNELEtBSkg7QUFLRCxHQVpEO0FBY0QsQ0ExR0QiLCJmaWxlIjoiU2VydmVyU3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBoYW5kbGVyID0gcmVxdWlyZSgnLi4vcmVxdWVzdC1oYW5kbGVyJyk7XG52YXIgZXhwZWN0ID0gcmVxdWlyZSgnY2hhaScpLmV4cGVjdDtcbnZhciBzdHVicyA9IHJlcXVpcmUoJy4vU3R1YnMnKTtcblxuLy8gQ29uZGl0aW9uYWwgYXN5bmMgdGVzdGluZywgYWtpbiB0byBKYXNtaW5lJ3Mgd2FpdHNGb3IoKVxuLy8gV2lsbCB3YWl0IGZvciB0ZXN0IHRvIGJlIHRydXRoeSBiZWZvcmUgZXhlY3V0aW5nIGNhbGxiYWNrXG52YXIgd2FpdEZvclRoZW4gPSBmdW5jdGlvbiAodGVzdCwgY2IpIHtcbiAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICB0ZXN0KCkgPyBjYi5hcHBseSh0aGlzKSA6IHdhaXRGb3JUaGVuKHRlc3QsIGNiKTtcbiAgfSwgNSk7XG59O1xuXG5kZXNjcmliZSgnTm9kZSBTZXJ2ZXIgUmVxdWVzdCBMaXN0ZW5lciBGdW5jdGlvbicsIGZ1bmN0aW9uKCkge1xuICBpdCgnU2hvdWxkIGFuc3dlciBHRVQgcmVxdWVzdHMgZm9yIC9jbGFzc2VzL21lc3NhZ2VzIHdpdGggYSAyMDAgc3RhdHVzIGNvZGUnLCBmdW5jdGlvbigpIHtcbiAgICAvLyBUaGlzIGlzIGEgZmFrZSBzZXJ2ZXIgcmVxdWVzdC4gTm9ybWFsbHksIHRoZSBzZXJ2ZXIgd291bGQgcHJvdmlkZSB0aGlzLFxuICAgIC8vIGJ1dCB3ZSB3YW50IHRvIHRlc3Qgb3VyIGZ1bmN0aW9uJ3MgYmVoYXZpb3IgdG90YWxseSBpbmRlcGVuZGVudCBvZiB0aGUgc2VydmVyIGNvZGVcbiAgICB2YXIgcmVxID0gbmV3IHN0dWJzLnJlcXVlc3QoJy9jbGFzc2VzL21lc3NhZ2VzJywgJ0dFVCcpO1xuICAgIHZhciByZXMgPSBuZXcgc3R1YnMucmVzcG9uc2UoKTtcblxuICAgIGhhbmRsZXIocmVxLCByZXMpO1xuXG4gICAgZXhwZWN0KHJlcy5fcmVzcG9uc2VDb2RlKS50by5lcXVhbCgyMDApO1xuICAgIGV4cGVjdChyZXMuX2VuZGVkKS50by5lcXVhbCh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoJ1Nob3VsZCBzZW5kIGJhY2sgcGFyc2FibGUgc3RyaW5naWZpZWQgSlNPTicsIGZ1bmN0aW9uKCkge1xuICAgIHZhciByZXEgPSBuZXcgc3R1YnMucmVxdWVzdCgnL2NsYXNzZXMvbWVzc2FnZXMnLCAnR0VUJyk7XG4gICAgdmFyIHJlcyA9IG5ldyBzdHVicy5yZXNwb25zZSgpO1xuXG4gICAgaGFuZGxlcihyZXEsIHJlcyk7XG5cbiAgICBleHBlY3QoSlNPTi5wYXJzZS5iaW5kKHRoaXMsIHJlcy5fZGF0YSkpLnRvLm5vdC50aHJvdygpO1xuICAgIGV4cGVjdChyZXMuX2VuZGVkKS50by5lcXVhbCh0cnVlKTtcbiAgfSk7XG5cbiAgaXQoJ1Nob3VsZCBzZW5kIGJhY2sgYW4gb2JqZWN0JywgZnVuY3Rpb24oKSB7XG4gICAgdmFyIHJlcSA9IG5ldyBzdHVicy5yZXF1ZXN0KCcvY2xhc3Nlcy9tZXNzYWdlcycsICdHRVQnKTtcbiAgICB2YXIgcmVzID0gbmV3IHN0dWJzLnJlc3BvbnNlKCk7XG5cbiAgICBoYW5kbGVyKHJlcSwgcmVzKTtcblxuICAgIHZhciBwYXJzZWRCb2R5ID0gSlNPTi5wYXJzZShyZXMuX2RhdGEpO1xuICAgIGV4cGVjdChwYXJzZWRCb2R5KS50by5iZS5hbignb2JqZWN0Jyk7XG4gICAgZXhwZWN0KHJlcy5fZW5kZWQpLnRvLmVxdWFsKHRydWUpO1xuICB9KTtcblxuICBpdCgnU2hvdWxkIHNlbmQgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYSBgcmVzdWx0c2AgYXJyYXknLCBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmVxID0gbmV3IHN0dWJzLnJlcXVlc3QoJy9jbGFzc2VzL21lc3NhZ2VzJywgJ0dFVCcpO1xuICAgIHZhciByZXMgPSBuZXcgc3R1YnMucmVzcG9uc2UoKTtcblxuICAgIGhhbmRsZXIocmVxLCByZXMpO1xuXG4gICAgdmFyIHBhcnNlZEJvZHkgPSBKU09OLnBhcnNlKHJlcy5fZGF0YSk7XG4gICAgZXhwZWN0KHBhcnNlZEJvZHkpLnRvLmhhdmUucHJvcGVydHkoJ3Jlc3VsdHMnKTtcbiAgICBleHBlY3QocGFyc2VkQm9keS5yZXN1bHRzKS50by5iZS5hbignYXJyYXknKTtcbiAgICBleHBlY3QocmVzLl9lbmRlZCkudG8uZXF1YWwodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KCdTaG91bGQgYWNjZXB0IHBvc3RzIHRvIC9jbGFzc2VzL3Jvb20nLCBmdW5jdGlvbigpIHtcbiAgICB2YXIgc3R1Yk1zZyA9IHtcbiAgICAgIHVzZXJuYW1lOiAnSm9ubycsXG4gICAgICBtZXNzYWdlOiAnRG8gbXkgYmlkZGluZyEnXG4gICAgfTtcbiAgICB2YXIgcmVxID0gbmV3IHN0dWJzLnJlcXVlc3QoJy9jbGFzc2VzL21lc3NhZ2VzJywgJ1BPU1QnLCBzdHViTXNnKTtcbiAgICB2YXIgcmVzID0gbmV3IHN0dWJzLnJlc3BvbnNlKCk7XG5cbiAgICBoYW5kbGVyKHJlcSwgcmVzKTtcblxuICAgIC8vIEV4cGVjdCAyMDEgQ3JlYXRlZCByZXNwb25zZSBzdGF0dXNcbiAgICBleHBlY3QocmVzLl9yZXNwb25zZUNvZGUpLnRvLmVxdWFsKDIwMSk7XG5cbiAgICAvLyBUZXN0aW5nIGZvciBhIG5ld2xpbmUgaXNuJ3QgYSB2YWxpZCB0ZXN0XG4gICAgLy8gVE9ETzogUmVwbGFjZSB3aXRoIHdpdGggYSB2YWxpZCB0ZXN0XG4gICAgLy8gZXhwZWN0KHJlcy5fZGF0YSkudG8uZXF1YWwoSlNPTi5zdHJpbmdpZnkoJ1xcbicpKTtcbiAgICBleHBlY3QocmVzLl9lbmRlZCkudG8uZXF1YWwodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KCdTaG91bGQgcmVzcG9uZCB3aXRoIG1lc3NhZ2VzIHRoYXQgd2VyZSBwcmV2aW91c2x5IHBvc3RlZCcsIGZ1bmN0aW9uKCkge1xuICAgIHZhciBzdHViTXNnID0ge1xuICAgICAgdXNlcm5hbWU6ICdKb25vJyxcbiAgICAgIG1lc3NhZ2U6ICdEbyBteSBiaWRkaW5nISdcbiAgICB9O1xuICAgIHZhciByZXEgPSBuZXcgc3R1YnMucmVxdWVzdCgnL2NsYXNzZXMvbWVzc2FnZXMnLCAnUE9TVCcsIHN0dWJNc2cpO1xuICAgIHZhciByZXMgPSBuZXcgc3R1YnMucmVzcG9uc2UoKTtcblxuICAgIGhhbmRsZXIocmVxLCByZXMpO1xuXG4gICAgZXhwZWN0KHJlcy5fcmVzcG9uc2VDb2RlKS50by5lcXVhbCgyMDEpO1xuXG4gICAgICAvLyBOb3cgaWYgd2UgcmVxdWVzdCB0aGUgbG9nIGZvciB0aGF0IHJvb20gdGhlIG1lc3NhZ2Ugd2UgcG9zdGVkIHNob3VsZCBiZSB0aGVyZTpcbiAgICByZXEgPSBuZXcgc3R1YnMucmVxdWVzdCgnL2NsYXNzZXMvbWVzc2FnZXMnLCAnR0VUJyk7XG4gICAgcmVzID0gbmV3IHN0dWJzLnJlc3BvbnNlKCk7XG5cbiAgICBoYW5kbGVyKHJlcSwgcmVzKTtcblxuICAgIGV4cGVjdChyZXMuX3Jlc3BvbnNlQ29kZSkudG8uZXF1YWwoMjAwKTtcbiAgICB2YXIgbWVzc2FnZXMgPSBKU09OLnBhcnNlKHJlcy5fZGF0YSkucmVzdWx0cztcbiAgICBleHBlY3QobWVzc2FnZXMubGVuZ3RoKS50by5iZS5hYm92ZSgwKTtcbiAgICBleHBlY3QobWVzc2FnZXNbMF0udXNlcm5hbWUpLnRvLmVxdWFsKCdKb25vJyk7XG4gICAgZXhwZWN0KG1lc3NhZ2VzWzBdLm1lc3NhZ2UpLnRvLmVxdWFsKCdEbyBteSBiaWRkaW5nIScpO1xuICAgIGV4cGVjdChyZXMuX2VuZGVkKS50by5lcXVhbCh0cnVlKTtcbiAgfSk7XG5cblxuICBpdCgnU2hvdWxkIDQwNCB3aGVuIGFza2VkIGZvciBhIG5vbmV4aXN0ZW50IGZpbGUnLCBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmVxID0gbmV3IHN0dWJzLnJlcXVlc3QoJy9hcmdsZWJhcmdsZScsICdHRVQnKTtcbiAgICB2YXIgcmVzID0gbmV3IHN0dWJzLnJlc3BvbnNlKCk7XG5cbiAgICBoYW5kbGVyKHJlcSwgcmVzKTtcblxuICAgIC8vIFdhaXQgZm9yIHJlc3BvbnNlIHRvIHJldHVybiBhbmQgdGhlbiBjaGVjayBzdGF0dXMgY29kZVxuICAgIHdhaXRGb3JUaGVuKFxuICAgICAgZnVuY3Rpb24oKSB7IHJldHVybiByZXMuX2VuZGVkOyB9LFxuICAgICAgZnVuY3Rpb24oKSB7XG4gICAgICAgIGV4cGVjdChyZXMuX3Jlc3BvbnNlQ29kZSkudG8uZXF1YWwoNDA0KTtcbiAgICAgIH0pO1xuICB9KTtcblxufSk7XG4iXX0=